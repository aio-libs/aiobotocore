---
name: Reusable test

permissions: {}

on:
  workflow_call:
    inputs:
      python-version:
        type: string
        required: true
      os:
        type: string
        required: true
      continue-on-error:
        type: boolean
      enable-cache:
        type: string
        required: true
      with-awscrt:
        type: boolean
        required: true
      no-httpx:
        type: boolean
        required: true
    secrets:
      codecov-token:
        required: false

env:
  FORCE_COLOR: 1

jobs:
  test:
    name: Test Python ${{ inputs.python-version }} on ${{ inputs.os }}${{
      inputs.with-awscrt && ' with-awscrt' || '' }}${{
      inputs.no-httpx && ' no-httpx' || '' }}

    runs-on: ${{ inputs.os }}
    continue-on-error: ${{ inputs.continue-on-error }}
    env:
      UV_FROZEN: 1
    timeout-minutes: 5

    steps:
    - name: Checkout
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
      with:
        persist-credentials: false
        submodules: true
    - name: Install uv
      # yamllint disable-line rule:line-length
      uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b  # v7.2.0
      with:
        python-version: ${{ inputs.python-version }}
        enable-cache: ${{ inputs.enable-cache }}
    - name: Install awscrt
      if: ${{ inputs.with-awscrt }}
      run: |
        uv sync --group awscrt
    - name: Run pre-commit hooks
      run: |
        uv run make pre-commit
    - name: Run unittests
      if: ${{ ! inputs.no-httpx }}
      env:
        COLOR: 'yes'
      run: |
        uv run --extra=httpx make mototest
    - name: Run unittests without httpx installed
      if: ${{ inputs.no-httpx }}
      env:
        COLOR: 'yes'
        HTTP_BACKEND: 'aiohttp'
      run: |
        uv run make mototest
    - name: Upload coverage to Codecov
      # yamllint disable-line rule:line-length
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de  # v5.5.2
      with:
        token: ${{ secrets.codecov-token }}  # not required for public repos
        files: ./coverage.xml
        # yamllint disable-line rule:line-length
        flags: unittests,os-${{ inputs.os }},python-${{ inputs.python-version }}${{ inputs.with-awscrt && ',with-awscrt' || '' }}${{ inputs.no-httpx && ',no-httpx' || '' }}  # optional
        name: codecov-umbrella  # optional
        fail_ci_if_error: true  # optional (default = false)
        verbose: true  # optional (default = false)
